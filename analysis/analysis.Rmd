---
output: html_document
---
<h2>  Xu and Tenenbaum 2007b Replication </h2>
<h3> Supplementary Information </h3>

***
***

**TABLE OF CONTENTS**<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**[(1) Xu and Tenenabum 2007b (original)](#o)** <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**[(2) Exp. 1 - online](#t1)** <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**[(3) Exp. 2 - online](#t2)** <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**[(4) Exp. 3 - in person](#l1)** <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**[(5) Exp. 4 - online](#t3)** <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**[(5) All](#all)** <br/>


This document was created from an R Markdown file. The R Markdown file can be found <a href="https://github.com/mllewis/xtSamp/blob/master/analysis/analysis.Rmd" target="_blank"> here</a>. All analyses and plots can be reproduced from the <a href="https://github.com/mllewis/xtSamp/tree/master/data" target="_blank">raw data</a> with the code in this file. This document also contains links to the experimental tasks.

***
***

```{r include = F}

rm(list = ls())

#--Load packages--
library(knitr)
library(boot)
library(ggplot2)
library(plyr)
library(dplyr)
library(pwr)

# graphical parameters
fs = 18
ts = 20

get.prop.CIs <- function(d, dv){ 
  prop = sum(d==dv)/length(d)

  # bootstrap across subject proportion responses for each category
  b <- boot(d, function(u, i) table(u[i])[dv]/length(u), R = 1000) 
  ci <- boot.ci(b, type = "perc")  
  ciwl = ci$percent[4]
  ciwu = ci$percent[5]
  
  p.CIS <- data.frame(ciwl = ciwl, ciul = ciwu, w.ans.cat = dv, ps.boot = prop)
  return (p.CIS)
}

theme_set(theme_bw())
themeML = theme(text = element_text(size=fs),
                plot.title=element_text(size=ts, face = "bold"),
                plot.background = element_blank(),
                panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),
                panel.border = element_blank(),
                axis.line = element_line(color = 'black')) 

d.fc <- function(response, cond) {

  # http://www.meta-analysis.com/downloads/Meta-analysis%20Converting%20among%20effect%20sizes.pdf
  #https://www.medcalc.net/tests/odds_ratio.php
  response = droplevels(response)
  response <- ordered(response, levels = c( "basic", "sub"))
  cond <- ordered(cond, levels = c( "learner", "teacher"))
  
  #use odds ratioto calculate d
  ns = table(cond, response)
  or = (ns[1]*ns[4])/(ns[2]*ns[3]) 
  cf = sqrt(3)/pi
  effect_size = log(or) * cf #calculate d
  
  # calculate 95 CI
  ## parametrically
  var_lor = (1/ns[1]) + (1/ns[2]) + (1/ns[3]) + (1/ns[4]) # sampling variance of lor
  var_d  = (3/(pi^2)) * var_lor # sampling variance of d
  d_err = sqrt(var_d) * 1.96
  
  cill = effect_size - d_err
  ciul = effect_size + d_err
  
  es <- data.frame(effect_size = effect_size, cill = cill, ciul = ciul)
  
  return (es)
}

opts_chunk$set(echo = T, message = F, warning = F, error = F, cache = F)
```

There are different possible criteria  for categorizing a participant as a subordinate or basic-level generalizer. X&T find that participants respond consistently across questions as either a subordinate or a basic generalizer for each of the two trials. In contrast, we observed a wide variety of responses across questions by participants in our sample. Thus, we adopt two criteria in analyzing our data: a "strict" criteria where we only include participants if they responded consistently ("yes" or "no" to all basic-level questions and "yes" or "no" to all subordinate level questions), and a "liberal" criteria where we counted a particpant as a basic generalizer if they responded "yes" to any of the basic level questions. The results of the liberal criteria are described in the Main Text, and the results of the strict criteria are described in Appendix A.

```{r, echo = F}
# Make analytical decisions
strict = TRUE
print(paste("Strict criteria: ", strict))

proper = FALSE # this only affects plots
```

<a name="o"/>
<h3> Original Xu and Tenenbaum 2007b </h3>

X&T 2007b data - adults
```{r}
N = 14
N_per_condition = N/2  # 2 conditions (teacher + learner)
# Note: The proportions described in the original report were obtained by aggegating across *trials* not participants (2 trials/participant). We correct for this here by taking the proportion of participants, which results in slightly different proportions than those reported in the original report.

prop_sub_teacher= .928 
n_sub_teacher = round(prop_sub_teacher * N_per_condition)
n_basic_teacher = N_per_condition - n_sub_teacher 
teacher_xt_data = as.factor(c(rep("sub", n_sub_teacher),
                              rep("basic", n_basic_teacher)))

prop_sub_learner = .357
n_sub_learner = round(prop_sub_learner * N_per_condition)
n_basic_learner= N_per_condition - n_sub_learner
learner_xt_data = as.factor(c(rep("sub", n_sub_learner), 
                              rep("basic", n_basic_learner)))

xt_data.adults = data.frame(response=c(as.character(teacher_xt_data),
                                       as.character(learner_xt_data)))
xt_data.adults$Answer.sample[1:N_per_condition] = "teacher"
xt_data.adults$Answer.sample[(N_per_condition+1):
                              (N_per_condition*2)] = "learner"

# get proportions and bootstrapped CIS
M <- data.frame()
for (k in 1:length(levels(learner_xt_data))){
    M = rbind(M, ddply(xt_data.adults, .(Answer.sample), 
                     function (d) {get.prop.CIs(d$response, levels(d$response)[k])}))
}

xt.a.props = M
names(xt.a.props)[names(xt.a.props) == "ps.boot"] = "prop"
xt.a.props$exp ="X&T (2007b)"

# add n's
xt.a.props[xt.a.props$Answer.sample == "teacher" &
           xt.a.props$w.ans.cat == "sub", "n" ] = n_sub_teacher 
xt.a.props[xt.a.props$Answer.sample == "teacher" & 
           xt.a.props$w.ans.cat == "basic", "n"] = n_basic_teacher 
xt.a.props[xt.a.props$Answer.sample == "learner" & 
           xt.a.props$w.ans.cat == "sub", "n" ] = n_sub_learner 
xt.a.props[xt.a.props$Answer.sample == "learner" & 
           xt.a.props$w.ans.cat == "basic", "n" ] = n_basic_learner 
```

X&T 2007b data - children
```{r}
N = 24
N_per_condition = N/2 # 2 conditions

prop_sub_teacher= .71
n_sub_teacher = round(prop_sub_teacher * N_per_condition)
n_basic_teacher = N_per_condition - n_sub_teacher 
teacher_xt_data = as.factor(c(rep("sub", n_sub_teacher),
                              rep("basic", n_basic_teacher)))

prop_sub_learner = .29
n_sub_learner = round(prop_sub_learner * N_per_condition)
n_basic_learner= N_per_condition - n_sub_learner
learner_xt_data = as.factor(c(rep("sub", n_sub_learner), 
                              rep("basic", n_basic_learner)))

xt_data.children = data.frame(response=c(as.character(teacher_xt_data),
                                       as.character(learner_xt_data)))
xt_data.children$Answer.sample[1:N_per_condition] = "teacher"
xt_data.children$Answer.sample[(N_per_condition+1):
                               (2*N_per_condition)] = "learner"

# get proportions and bootstrapped CIS
M <- data.frame()
for (k in 1:length(levels(learner_xt_data))){
    M = rbind(M, ddply(xt_data.children, .(Answer.sample), 
                     function (d) {get.prop.CIs(d$response, levels(d$response)[k])}))
}

xt.c.props = M
names(xt.c.props)[names(xt.c.props) == "ps.boot"] = "prop"
xt.c.props$exp ="X&T (2007b) children"

# add n's
xt.c.props[xt.c.props$Answer.sample == "teacher" &
           xt.c.props$w.ans.cat== "sub", "n" ] = n_sub_teacher 
xt.c.props[xt.c.props$Answer.sample == "teacher" & 
           xt.c.props$w.ans.cat== "basic", "n"] = n_basic_teacher 
xt.c.props[xt.c.props$Answer.sample == "learner" & 
           xt.c.props$w.ans.cat== "sub", "n" ] = n_sub_learner 
xt.c.props[xt.c.props$Answer.sample == "learner" & 
           xt.c.props$w.ans.cat== "basic", "n" ] = n_basic_learner 
```

```{r, echo = F}
xt = rbind(xt.c.props, xt.a.props)
xt$exp = revalue(xt$exp,c("X&T (2007b) children" = "children",
                          "X&T (2007b)" = "adults"))
# re-order levels so consistent with other exps
xt$Answer.sample <- ordered(xt$Answer.sample, 
                    levels = c("teacher", "learner"))

ggplot(xt, aes(x=factor(w.ans.cat), y=prop, fill=Answer.sample)) +
  facet_grid(. ~ exp) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_linerange(aes(ymin=ciwl,ymax=ciul), position=position_dodge(.9)) +
  ylim(0,1) +
  ylab("Prop. participants") +
  xlab("Generalization pattern") +
  scale_fill_brewer(name="Sampling\nCondition", palette="Set1") +
  ggtitle("Original Xu and Tenenbaum Data") +
  themeML  
```

<a name="t1"/>
<h3> Experiment 1 </h3>

Read in data and pre-process.
```{r}
t1 = read.csv("../data/anonymized/turk_replication_1_A.csv")

# make factors
t1$Answer.sample <- factor(t1$Answer.sample, labels=c('teacher','learner')) # sample0= teacher, sample1=learner
t1$Answer.label <- factor(t1$Answer.label, labels=c('nolabel','label')) # 0=nolabel, 1=label

t1 <- colwise(as.factor)(t1)
```

Filter.
```{r}
# get number of exclusions by category
t1.exclusion.ns = t1 %>%
              summarise(n_noLabelParticipants = length(which(Answer.label != 'label')),
                        n_repeatWorkers = length(which(duplicated(workerids))),
                        n_badTraining = length(which(Answer.click1 == "\"false\"" | 
                                                       Answer.click2 == "\"false\"")),
                        n_badGeneralize = length(which(Answer.Qwcheck != 0)),
                        n_badFilter = length(which(Answer.question1 == 'FALSE')))

t1.exclusion.ns

# subset data
t1.f = t1 %>%
       filter(Answer.label == 'label') %>% #remove nolabel participants (run 4)
       filter(!duplicated(workerids)) %>% #participants who completed multiple runs
       filter(Answer.click1 == "\"correct\"" & 
                Answer.click2 == "\"correct\"") %>% #correct training items (learning only)
       filter(Answer.Qwcheck == 0)  %>% #check generalization question
       filter(Answer.question1 == 'TRUE') #filter question

dim(t1)[1] # total
dim(t1)[1] - t1.exclusion.ns[1,"n_noLabelParticipants"] - t1.exclusion.ns[1,"n_repeatWorkers"] # actual total
dim(t1.f)[1] # total with exclusions
```

Categorize response patterns based on criterion.
```{r}
sub <- t1.f$Answer.Qwsmm1 == 0 & t1.f$Answer.Qwsmm2 == 0 & 
  t1.f$Answer.Qwsm1 == 1 & t1.f$Answer.Qwsm2 == 1
if (strict){
  basic <- (t1.f$Answer.Qwsmm1 == 1 & t1.f$Answer.Qwsmm2 == 1) &
      t1.f$Answer.Qwsm1 == 1 & t1.f$Answer.Qwsm2 == 1 
} else {
  basic <- (t1.f$Answer.Qwsmm1 == 1 | t1.f$Answer.Qwsmm2 == 1) &
       t1.f$Answer.Qwsm1 == 1 & t1.f$Answer.Qwsm2 == 1 
}

t1.f$w.ans.cat <- "other"
t1.f$w.ans.cat[sub] <- "sub"
t1.f$w.ans.cat[basic] <- "basic"

if (proper){
  #proper <- t1.f$Answer.Qwsmm1 == 0 & t1.f$Answer.Qwsmm2 == 0 & 
  #      (t1.f$Answer.Qwsm1 == 0 & t1.f$Answer.Qwsm2 == 0)
  proper <- t1.f$Answer.Qwsmm1 == 0 & t1.f$Answer.Qwsmm2 == 0 & 
        (t1.f$Answer.Qwsm1 == 0 | t1.f$Answer.Qwsm2 == 0)
  t1.f$w.ans.cat[proper] <- "proper"
  t1.f$w.ans.cat = factor(t1.f$w.ans.cat, levels=c("proper", "sub", "basic", "other"))
} else {
  t1.f$w.ans.cat = factor(t1.f$w.ans.cat, levels=c("sub", "basic", "other"))
}

# filter out other responses
length(which(t1.f$w.ans.cat == "other"))
t1.f = t1.f[t1.f$w.ans.cat != "other",]
t1.f$w.ans.cat = droplevels(t1.f$w.ans.cat)

# get proportions and bootstrapped CIS
M <- data.frame()
for (k in 1:length(levels(t1.f$w.ans.cat))){
    M = rbind(M, ddply(t1.f, .(Answer.sample), 
                     function (d) {get.prop.CIs(d$w.ans.cat, levels(d$w.ans.cat)[k])}))
}

t1.f.props = t1.f %>%
          group_by(Answer.sample, w.ans.cat) %>%
          summarise (n = n()) %>%
          mutate(prop = n / sum(n),
                 exp = "Turk #1") %>%
          left_join(M)
```

```{r, echo = F}
ggplot(t1.f.props, aes(x=factor(w.ans.cat), y=prop, fill=Answer.sample)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_linerange(aes(ymin=ciwl,ymax=ciul), position=position_dodge(.9)) +
  ylim(0,1) +
  ylab("Prop. participants") +
  xlab("Generalization pattern") +
  ggtitle("Turk Replication #1") +
  theme(legend.position=c(.85,.8)) + 
  themeML  +
  scale_fill_brewer(name="Sampling\nCondition", palette="Set1")
```

Stats
```{r}
t1_tab = table(t1.f$w.ans.cat, t1.f$Answer.sample)[c("sub", "basic"),]
chisq.test(t1_tab)
```

<a name="t2"/>
<h3> Experiment 2 </h3>

Read in data and pre-process
```{r}
t2 <- read.csv("../data/anonymized/turk_replication_2_A.csv", header=T)
t2  <- t2 [,c(-1:-19,-21:-32,-36,-41:-43,-54:-55,-56)] # remove unnecessary columns

# make factors
t2$Answer.sample <- factor(t2$Answer.sample, labels=c('teacher','learner')) # sample0 = teacher, sample1=learner
t2 <- colwise(as.factor)(t2)
```

Filter.
```{r}
# get number of exclusions by category
t2.exclusion.ns = t2 %>%
              summarise(n_badTraining = length(which(Answer.click1 != "\"correct\"" |
                                                       Answer.click2 != "\"correct\"")),
                        n_badGeneralize = length(which(Answer.Qcheck1 != 0 | Answer.Qcheck2 != 0)),
                        n_badFilter = length(which(Answer.question1 != 'true' | 
                                                     Answer.question2 != 'true' | 
                                                     Answer.question3 != 'true' | Answer.question4 !='true')))
t2.exclusion.ns

# subset data
t2.f = t2 %>%
       filter(Answer.click1 == "\"correct\"" &
                Answer.click2 == "\"correct\"") %>% # take out those who click on wrong training items
      filter(Answer.Qcheck1 == 0 & Answer.Qcheck2 == 0) %>% # take out if missed check generalization question
      filter(Answer.question1 != 'true' | Answer.question2 != 'true' | Answer.question3 == 'true' & Answer.question4 =='true')  # take out those who missed attention check questions

dim(t2)[1] # total
dim(t2.f)[1] # total with exclusions
```


Categorize response patterns based on criterion.
```{r}
sub <-  t2.f$Answer.Qproper1 == 1 & t2.f$Answer.Qproper2 == 1 & 
  t2.f$Answer.Qproper3 == 1 & t2.f$Answer.Qsub1 == 1 &
  t2.f$Answer.Qsub2 == 1 & t2.f$Answer.Qbasic1 == 0 &
  t2.f$Answer.Qbasic2 == 0 & t2.f$Answer.Qbasic3 == 0 

if (strict){
  basic <- t2.f$Answer.Qproper1 == 1 & t2.f$Answer.Qproper2 == 1 & 
    t2.f$Answer.Qproper3 == 1 & t2.f$Answer.Qsub1 == 1 &
    t2.f$Answer.Qsub2 == 1 & t2.f$Answer.Qbasic1 == 1 &
    t2.f$Answer.Qbasic2 == 1 & t2.f$Answer.Qbasic3 == 1 
} else {
  basic <- t2.f$Answer.Qproper1 == 1 & t2.f$Answer.Qproper2 == 1 & 
    t2.f$Answer.Qproper3 == 1 & t2.f$Answer.Qsub1 == 1 &
    t2.f$Answer.Qsub2 == 1 & (t2.f$Answer.Qbasic1 == 1 |
    t2.f$Answer.Qbasic2 == 1 | t2.f$Answer.Qbasic3 == 1)
}

t2.f$w.ans.cat <- "other"
t2.f$w.ans.cat[sub] <- "sub"
t2.f$w.ans.cat[basic] <- "basic"

if(proper){
  proper <- (t2.f$Answer.Qproper1 == 1 & t2.f$Answer.Qproper2 == 1 & 
    t2.f$Answer.Qproper3 == 1) & t2.f$Answer.Qsub1 == 0 &
    t2.f$Answer.Qsub2 == 0 & t2.f$Answer.Qbasic1 == 0 &
    t2.f$Answer.Qbasic2 == 0 & t2.f$Answer.Qbasic3 == 0 
    
    t2.f$w.ans.cat[proper] <- "proper"
    t2.f$w.ans.cat = factor(t2.f$w.ans.cat, levels=c("proper", "sub", "basic", "other"))

} else {
  t2.f$w.ans.cat = factor(t2.f$w.ans.cat, levels=c("sub", "basic", "other"))
}

# filter out "other" responses
length(which(t2.f$w.ans.cat == "other"))
t2.f = t2.f[t2.f$w.ans.cat != "other",]
t2.f$w.ans.cat = droplevels(t2.f$w.ans.cat)

# get proportions and bootstrapped CIS
M <- data.frame()
for (k in 1:length(levels(t2.f$w.ans.cat))){
    M = rbind(M, ddply(t2.f, .(Answer.sample), 
                     function (d) {get.prop.CIs(d$w.ans.cat, levels(d$w.ans.cat)[k])}))
}

t2.f.props = t2.f %>%
          group_by(Answer.sample, w.ans.cat) %>%
          summarise (n = n()) %>%
          mutate(prop = n / sum(n),
                 exp = "Turk #2") %>%
          left_join(M)
```

```{r, echo = F}
ggplot(t2.f.props, aes(x = factor(w.ans.cat), y = prop, fill = Answer.sample)) +
  geom_bar(stat ="identity", position = position_dodge()) +
  geom_linerange(aes(ymin = ciwl, ymax = ciul), position = position_dodge(.9)) +
  ylim(0,1) +
  ylab("Prop. participants") +
  xlab("Generalization pattern") +
  ggtitle("Turk Replication #2") +
  themeML + 
  theme(legend.position=c(.85, .8)) + 
  scale_fill_brewer(name="Sampling\nCondition", palette="Set1")
```

Stats 
```{r}
t2_tab = table(t2.f$w.ans.cat, t2.f$Answer.sample)[c("sub", "basic"),]
chisq.test(t2_tab)
```


<a name="l1"/>
<h3> Experiment 3 - In Lab Replication </h3>

```{r}
l1 <- read.csv("../data/anonymized/inlab_replication.csv")

# make factors
l1 <- colwise(as.factor)(l1)
names(l1)[names(l1) == "sample"] = "Answer.sample"

```

Filter.
```{r}
l1.exclusion.ns = l1 %>%
                  summarise(n_badTraining = length(which(t2_a == 0 | t3_a == 0 |
                                                           t2_b == 0 | t2_b == 0)))
l1.exclusion.ns

# subset data
l1.f = l1 %>%
       filter(t2_a == 1 & t3_a == 1 & t2_b == 1 & t2_b == 1)

dim(l1)[1] # total
dim(l1.f)[1] # total with exclusions
```

Categorize response patterns based on criterion.
```{r}
sub <- l1.f$basic1_a == 0 & l1.f$basic2_a == 0 & 
       l1.f$basic1_b == 0 & l1.f$basic2_b == 0 & 
       (l1.f$sub1_a == 1 & l1.f$sub2_a == 1 & 
          l1.f$sub1_b == 1 & l1.f$sub2_b == 1)
if (strict){
    basic <- (l1.f$basic1_a == 1 & l1.f$basic2_a == 1 &
            l1.f$basic1_b == 1 & l1.f$basic2_b == 1) & 
           (l1.f$sub1_a == 1 & l1.f$sub2_a == 1 & 
              l1.f$sub1_b == 1 & l1.f$sub2_b == 1)
  
} else {
  basic <- (l1.f$basic1_a == 1 | l1.f$basic2_a == 1 | 
            l1.f$basic1_b == 1 | l1.f$basic2_b == 1) & 
           (l1.f$sub1_a == 1 & l1.f$sub2_a == 1 & 
              l1.f$sub1_b == 1 & l1.f$sub2_b == 1)
}

l1.f$w.ans.cat <- "other"
l1.f$w.ans.cat[sub] <- "sub"
l1.f$w.ans.cat[basic] <- "basic"

if (proper){
  proper <- l1.f$basic1_a == 0 & l1.f$basic2_a == 0 & 
            l1.f$basic1_b == 0 & l1.f$basic2_b == 0 & 
            (l1.f$sub1_a == 0 | l1.f$sub2_a == 0 |
               l1.f$sub1_b == 0 | l1.f$sub2_b == 0)
  l1.f$w.ans.cat[proper] <- "proper"
  l1.f$w.ans.cat <- factor(l1.f$w.ans.cat,c("proper","sub","basic","other"))
} else {
  l1.f$w.ans.cat <- factor(l1.f$w.ans.cat,c("sub","basic","other"))
}

# filter out "other"" responses
length(which(l1.f$w.ans.cat  == "other"))
l1.f = l1.f[l1.f$w.ans.cat != "other",]
l1.f$w.ans.cat = droplevels(l1.f$w.ans.cat)

# get proportions and bootstrapped CIS
M <- data.frame()
for (k in 1:length(levels(l1.f$w.ans.cat))){
    M = rbind(M, ddply(l1.f, .(Answer.sample), 
                     function (d) {get.prop.CIs(d$w.ans.cat, levels(d$w.ans.cat)[k])}))
}

l1.f.props = l1.f %>%
          group_by(Answer.sample, w.ans.cat) %>%
          summarise (n = n()) %>%
          mutate(prop = n / sum(n),
                 exp = "In Lab") %>%
          left_join(M)

# re-order levels so consistent with other exps
l1.f.props$Answer.sample <- ordered(l1.f.props$Answer.sample, 
                    levels = c("teacher", "learner"))
```

```{r, echo = F}
ggplot(l1.f.props, aes(x=factor(w.ans.cat), y = prop, fill = Answer.sample)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_linerange(aes(ymin=ciwl, ymax=ciul), position = position_dodge(.9)) +
  ylim(0,1) +
  ylab("Prop. participants") +
  xlab("Generalization pattern") +
  ggtitle("In Lab") +
  themeML + 
  scale_fill_brewer(name="Sampling\nCondition", palette="Set1")
```

Stats
```{r}
l1_tab = table(l1.f$w.ans.cat, l1.f$sample)[c("sub", "basic"),]
chisq.test(l1_tab)
```

<a name="t3"/>
<h3> Experiment 4 - Turk Replication #3 </h3>

Read in data and pre-process
```{r}
t3 <- read.csv("../data/anonymized/turk_replication_3_A.csv")

# make factors
t3$Answer.sample <- factor(t3$Answer.sample, labels=c('teacher','learner')) # sample0 = teacher, sample1=learner
t3 <- colwise(as.factor)(t3)
```

Filter.
```{r}
t3.exclusion.ns = t3 %>%
              summarise(n_badTraining = length(which(Answer.click1 != "\"correct\"" | 
                                                       Answer.click2 != "\"correct\"")),
                        n_badGeneralize = length(which(Answer.Qcheck1 != 0 | Answer.Qcheck2 != 0)),
                        n_badFilter = length(which(Answer.question1 != 'TRUE' | Answer.question2 !='TRUE'| 
                                Answer.question3 != 'TRUE' | Answer.question4 !='TRUE')))
t3.exclusion.ns

# subset data
t3.f= t3 %>%
      filter(Answer.click1 == "\"correct\"" & 
                Answer.click2 == "\"correct\"") %>% # take out those who click on wrong training items
      filter(Answer.Qcheck1 == 0 & Answer.Qcheck2 == 0) %>% # take out if missed check generalization question
      filter(Answer.question1 == 'TRUE' & Answer.question2 =='TRUE' & 
            Answer.question3 == 'TRUE' & Answer.question4 =='TRUE')  # take out those who missed filter question

dim(t3)[1] # total
dim(t3.f)[1] # total with exclusions
```


Categorize response patterns based on criterion.
```{r}
sub <-  t3.f$Answer.Qproper1 == 1 & t3.f$Answer.Qproper2 == 1 & 
    t3.f$Answer.Qproper3 == 1 & t3.f$Answer.Qsub1 == 1 &
    t3.f$Answer.Qsub2 == 1 & t3.f$Answer.Qbasic1 == 0 &
    t3.f$Answer.Qbasic2 == 0 & t3.f$Answer.Qbasic3 == 0 

if (strict){
  basic <- t3.f$Answer.Qproper1 == 1 & t3.f$Answer.Qproper2 == 1 & 
    t3.f$Answer.Qproper3 == 1 & t3.f$Answer.Qsub1 == 1 &
    t3.f$Answer.Qsub2 == 1 & t3.f$Answer.Qbasic1 == 1 &
    t3.f$Answer.Qbasic2 == 1 & t3.f$Answer.Qbasic3 == 1 
} else {
  basic <- t3.f$Answer.Qproper1 == 1 & t3.f$Answer.Qproper2 == 1 & 
      t3.f$Answer.Qproper3 == 1 & t3.f$Answer.Qsub1 == 1 &
      t3.f$Answer.Qsub2 == 1 & (t3.f$Answer.Qbasic1 == 1 |
      t3.f$Answer.Qbasic2 == 1 | t3.f$Answer.Qbasic3 == 1)
}

t3.f$w.ans.cat <- "other"
t3.f$w.ans.cat[sub] <- "sub"
t3.f$w.ans.cat[basic] <- "basic"

if (proper){
  proper <- (t3.f$Answer.Qproper1 == 1 & t3.f$Answer.Qproper2 == 1 & 
            t3.f$Answer.Qproper3 == 1) & t3.f$Answer.Qsub1 == 0 &
            t3.f$Answer.Qsub2 == 0 & t3.f$Answer.Qbasic1 == 0 &
            t3.f$Answer.Qbasic2 == 0 & t3.f$Answer.Qbasic3 == 0 
  
  t3.f$w.ans.cat[proper] <- "proper"
  t3.f$w.ans.cat = factor(t3.f$w.ans.cat, levels=c("proper", "sub", "basic", "other"))
} else { 
  t3.f$w.ans.cat = factor(t3.f$w.ans.cat, levels=c("sub", "basic", "other"))
}

# filter out "other"" responses
length(which(t3.f$w.ans.cat == "other"))
t3.f = t3.f[t3.f$w.ans.cat != "other",]
t3.f$w.ans.cat = droplevels(t3.f$w.ans.cat)

# get proportions and bootstrapped CIS
M <- data.frame()
for (k in 1:length(levels(t3.f$w.ans.cat))){
    M = rbind(M, ddply(t3.f, .(Answer.sample), 
                     function (d) {get.prop.CIs(d$w.ans.cat, levels(d$w.ans.cat)[k])}))
}

t3.f.props = t3.f %>%
          group_by(Answer.sample, w.ans.cat) %>%
          summarise (n = n()) %>%
          mutate(prop = n / sum(n),
                 exp = "Turk #3") %>%
          left_join(M)
```

```{r,echo = F}
ggplot(t3.f.props, aes(x = factor(w.ans.cat), y = prop, fill = Answer.sample)) +
  geom_bar(stat = "identity", position=position_dodge()) +
  geom_linerange(aes(ymin = ciwl,ymax = ciul), position = position_dodge(.9)) +
  ylim(0,1) +
  ylab("Prop. participants") +
  xlab("Generalization pattern") +
  ggtitle("Turk Replication #3") +
  themeML + 
  theme(legend.position = c(.85,.8)) + 
    scale_fill_brewer(name = "Sampling\nCondition", palette = "Set1")
```

Stats
```{r}
t3_tab = table(t3.f$w.ans.cat, t3.f$Answer.sample)[c("sub", "basic"),]
chisq.test(t3_tab)
```

<a name="all"/>
<h3> All experiments </h3>

```{r}
# bind all props together
lf.props = rbind(t1.f.props, t2.f.props, t3.f.props, l1.f.props)
lf.props$ps.boot <- NULL
all.props= rbind(lf.props, xt.a.props, xt.c.props)

all.props$exp <- ordered(as.factor(all.props$exp), 
                    levels = c( "X&T (2007b) children", "X&T (2007b)", "Turk #1", 
                                "Turk #2", "In Lab", "Turk #3"))

all.props$exp = revalue(all.props$exp, c("X&T (2007b)" = "X&T adults", "X&T (2007b) children" = "X&T children", "Turk #1" = "Exp. 1", "Turk #2" = "Exp. 2", "In Lab" = "Exp. 3", "Turk #3" = "Exp. 4"))
all.props$w.ans.cat  = revalue(all.props$w.ans.cat , c("sub" = "sub."))

all.props.crit = all.props[all.props$w.ans.cat == "basic" | all.props$w.ans.cat == "sub.",]
```

```{r, fig.width = 10, echo = F}
#pdf("../../writeup/figures/FIG_2.pdf", height = 4, width = 12)
ggplot(all.props.crit, aes(x = w.ans.cat, y = prop, fill = Answer.sample)) +
  geom_bar(stat="identity", position = position_dodge()) +
  facet_grid(. ~ exp) +
  geom_rect(data = all.props.crit[17:24,], fill = "gray", 
            xmin = -Inf,xmax = Inf, ymin = -Inf,ymax = Inf, alpha = 0.07) +
  geom_linerange(aes(ymin = ciwl,ymax = ciul), position=position_dodge(.9)) +
  ylim(0, 1) +
  ylab("Prop. Participants") +
  xlab("Generalization Pattern") +
  themeML + 
  scale_fill_brewer(name ="Sampling\nCondition", palette = "Set1") 
#dev.off()
```

Effect sizes
```{r}
t1.f.es = d.fc(t1.f$w.ans.cat, t1.f$Answer.sample)
t2.f.es= d.fc(t2.f$w.ans.cat, t2.f$Answer.sample)
t3.f.es = d.fc(t3.f$w.ans.cat, t3.f$Answer.sample)
l1.f.es= d.fc(l1.f$w.ans.cat, l1.f$Answer.sample)
xt.a.es = d.fc(xt_data.adults$response, xt_data.adults$Answer.sample)
xt.c.es = d.fc(xt_data.children$response, xt_data.children$Answer.sample)

all.es = rbind(t1.f.es, t2.f.es, t3.f.es, l1.f.es, xt.a.es, xt.c.es)
all.es$exp = c("Turk #1" ,"Turk #2", "Turk #3", "In Lab" ,
               "X&T adults", "X&T children")
all.es$exp<- ordered(as.factor(all.es$exp), 
                     levels = c( "X&T children", "X&T adults", "Turk #1" ,"Turk #2", 
                                  "In Lab", "Turk #3"))
all.es$exp = revalue(all.es$exp, c( "Turk #1" = "Exp. 1",
                                "Turk #2" = "Exp. 2", "In Lab" = "Exp. 3", 
                                "Turk #3" = "Exp. 4"))
all.es
```

```{r, echo = F}
#pdf("../../writeup/figures/FIG_3.pdf", height = 4, width = 4)
ggplot(all.es, aes(x = exp, y = effect_size, ymin = cill, ymax = ciul)) + 
  geom_pointrange(position = position_dodge(width = 0.25), size = .8) + 
  ylab("Effect Size") + 
  xlab("Experiment") + 
  geom_hline(y = 0, linetype = "dotted") +
  theme(text = element_text(size = 16)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#dev.off()
```

Power analysis, based on effect size estimated from Exps 1-4 and XT-Adult
```{r}
xt_data.adults$exp = "xt_data.adults"
t1.f$exp = "t1"
t2.f$exp = "t2"
t3.f$exp = "t3"
l1.f$exp = "l1"
xt_data.adults$w.ans.cat = xt_data.adults$response
all.data.f = rbind(xt_data.adults[,c("Answer.sample", "w.ans.cat", "exp")],
                   t1.f[,c("Answer.sample", "w.ans.cat", "exp")],
                   t2.f[,c("Answer.sample", "w.ans.cat", "exp")],
                   l1.f[,c("Answer.sample", "w.ans.cat", "exp")],
                   t3.f[,c("Answer.sample", "w.ans.cat", "exp")])
all.data.f <- colwise(as.factor)(all.data.f)

# get count data
all.data.f_tab = table(all.data.f$w.ans.cat, 
                       all.data.f$Answer.sample)[c("sub", "basic"),]
# get effect size
all.es = d.fc(all.data.f$w.ans.cat, all.data.f$Answer.sample)
print(paste("Effect size:", all.es[1]))

power.analysis = pwr.chisq.test(w = all.es[1],df = 1, sig.level = 0.05, power = .95)

power.analysis 

print(paste("N for .95 power:", power.analysis$N))
```